---
layout: post
title:  "Analyze .NET deserialization: TypeConfuseDelegate gadget chain"
date:   2022-07-18 9:00:00 +0700
categories: research
author: Quang Vo
tags: .net,c#, deserialization
description: Research
---

## Introduction
`TypeConfuseDelegate` is a gadget chain take advantage of `SortedSet` class calls the **comparator** class to sort while deserializing, which is an input that attacker can controls and **multicast delegate** can modify the characteristics of delegateinstance to trigger code execution during deserialization process.

## About SortedSet class

In its simplest form, `SortedSet` take a comparator as an input, and then you call `Add` to add elements that you want to compare to sort

```c#
// Create a sorted set using the ByFileExtension comparer.
var set = new SortedSet<string>(new ByFileExtension());
set.Add("hello.a");
set.Add("hello.b");
```
In the code above, `ByFileExtension` is a comparator which is inherited from `IComparer<T>` interface

![image](https://user-images.githubusercontent.com/37280106/179691068-5673d40f-8110-4bf7-9da8-9e899bba6413.png)

In this interface, it defines a method `int Compare(T x, T y)` . This method is used to compare 2 objects that have the same Type.

When we call `Add(T x)` for the first time, the comparator won't be called, **only after the second call to `Add(T x)`, the comparator is called** ( gotta need something to compare with right ? :D )
